<!DOCTYPE html>
<html lang="ru">

<head>
  <style></style>
</head>

<body>
  <h1>Бренды</h1>

  <input type="submit" id="add" value="добавить бренд" />
  <script>
    "use strict"
    add.addEventListener('click', event => {
      editForm.hidden = false;
      editForm.reset();
      editForm.dataset.action = 'added';
    })
  </script>

  <form hidden="hidden" id="editForm" data-action="">
    <input type="text" name="title" />
    <input type="submit" value="send" />
  </form>
  <script>
    "use strict"
    editForm.addEventListener('submit', event => {
      event.preventDefault();

      const options = {
        body: new FormData(event.target),
      };
      let url;

      if (event.target.dataset.action === 'added') {
        options.method = 'POST';
        url = '/api/brands';

        event.target.querySelector('input[type=submit]').disabled = true;
        fetch(url, options)
          .then(async response => {
            if (response.ok) {
              const brand = await response.json();
              addBrand(brand)
            }
            else if (response.status === 400) {
              const res = await response.json();
              console.log(res);
            }
            else {
              throw new Error(`query status ${response.status}`)
            }
          })
          .catch(error => console.log(error))
          .finally(_ => {
            event.target.querySelector('input[type=submit]').disabled = false;
            event.target.hidden = true;
          })
        return;
      }

      if (event.target.dataset.action === 'updated') {
        options.method = 'PATCH';
        url = '/api/brands';
        return;
      }
    })
  </script>

  <ul id="list"></ul>
  <script>
    "use strict"

    fetch('/api/brands')
      .then(async response => {
        if (response.ok) {
          const brands = await response.json();
          brands.map(brand => addBrand(brand))
        }
        else {
          throw new Error(`query status ${response.status}`)
        }
      })
      .catch(error => console.log(error));

    function addBrand(brand) {
      list.insertAdjacentHTML('afterbegin', `<li data-id="${brand.id}">${brand.title}</li>`)
    }

    list.addEventListener('click', event => {
      if (!event.target.closest('li')) return;
      console.log(event.target.dataset.id)
      
      editForm.hidden = false;
      editForm.reset();
      editForm.dataset.action = 'updated'
    })
  </script>
</body>

</html>